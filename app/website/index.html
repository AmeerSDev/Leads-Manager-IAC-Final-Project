<!DOCTYPE html>
<html ng-app="crudApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leads Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.3/angular.min.js"></script>
    <script src="{{ url_for('static', filename='controller.js') }}"></script>
    <script src="{{ url_for('static', filename='leadsService.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body ng-controller="CrudController">
    <div class="page">
        <header class="hero">
            <div class="hero-left">
                <p class="eyebrow">Open deals. Track metrics. All customers.</p>
                <h1>Leads Manager</h1>
                <p class="subtitle">A clean pipeline view with instant persistence and a CI/CD-ready stack.</p>
            </div>
            <div class="hero-stats">
                <div class="stat-card">
                    <span class="label">Open Deals</span>
                    <span class="value" ng-bind="usersOBJ.filter(u => u.is_active).length"></span>
                </div>
                <div class="stat-card">
                    <span class="label">Total Leads</span>
                    <span class="value" ng-bind="usersOBJ.length"></span>
                </div>
            </div>
        </header>

        <main class="content">
            <section class="panel form-panel">
                <div class="panel-header">
                    <h2 ng-bind="isEditing ? 'Edit Lead' : 'Add Lead'"></h2>
                    <p class="helper">IDs should be unique. Data persists automatically.</p>
                </div>
                <form name="userForm" ng-submit="saveUser()" novalidate class="grid">
                    <label class="field">
                        <span>Name</span>
                        <input type="text" name="name" ng-model="currentUser.name" required placeholder="Jane">
                        <small class="error" ng-show="userForm.name.$touched && userForm.name.$invalid">Required</small>
                    </label>
                    <label class="field">
                        <span>Last Name</span>
                        <input type="text" name="last_name" ng-model="currentUser.last_name" required placeholder="Doe">
                        <small class="error" ng-show="userForm.last_name.$touched && userForm.last_name.$invalid">Required</small>
                    </label>
                    <label class="field">
                        <span>Deal ID</span>
                        <input type="number" name="dealid" ng-model="currentUser['deal-id']" required placeholder="1001">
                        <small class="error" ng-show="userForm.dealid.$touched && userForm.dealid.$invalid">Required</small>
                    </label>
                    <label class="field">
                        <span>Estimated Value</span>
                        <input type="number" name="est_value" ng-model="currentUser.est_value" required placeholder="5000">
                        <small class="error" ng-show="userForm.est_value.$touched && userForm.est_value.$invalid">Required</small>
                    </label>
                    <div class="actions">
                        <button type="submit" class="btn btn-primary" ng-disabled="userForm.$invalid"
                                ng-bind="isEditing ? 'Update Lead' : 'Add Lead'"></button>
                    </div>
                </form>
                <div ng-show="message.text" class="alert" ng-class="{'alert-success': message.type === 'success', 'alert-error': message.type === 'error'}">
                    <span ng-bind="message.text"></span>
                </div>
            </section>

            <section class="panel table-panel" id="leads-table">
                <div class="panel-header">
                    <h2>Leads Tracker</h2>
                </div>
                <div class="table-container" ng-show="usersOBJ.length > 0">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Last</th>
                                <th>Deal ID</th>
                                <th>Status</th>
                                <th>Est. Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="user in usersOBJ">
                                <td ng-bind="$index + 1"></td>
                                <td ng-bind="user.name"></td>
                                <td ng-bind="user.last_name"></td>
                                <td ng-bind="user['deal-id']"></td>
                                <td>
                                    <span class="status-badge" ng-class="{'active': user.is_active}">
                                        <span class="dot"></span>
                                        <span ng-bind="user.is_active ? 'Active' : 'Closed'"></span>
                                    </span>
                                </td>
                                <td ng-bind="user.est_value | currency"></td>
                                <td class="row-actions">
                                    <button class="icon-btn edit" title="Edit" ng-click="editUser($index,user)">✎</button>
                                    <button class="icon-btn danger" title="Delete" ng-click="deleteUser($index)">✕</button>
                                    <button class="icon-btn success" title="Close deal" ng-if="user.is_active" ng-click="closeDeal(user['deal-id'])">✓</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="empty-state" ng-show="usersOBJ.length === 0">
                    <p>No leads yet. Add one to get started.</p>
                    <button class="btn btn-primary" ng-click="resetForm()">Create Lead</button>
                </div>
            </section>
        </main>
    </div>
</body>
</html>
